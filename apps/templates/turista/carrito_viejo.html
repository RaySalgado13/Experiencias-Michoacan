{% extends "layouts/base-turista.html" %}
{% load static %}

{% block title %} eCommerce {% endblock %} 

{% block stylesheets %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
<link rel="stylesheet" href="/static/assets/css/styles-turista.css">
<!-- Google Font: Source Sans Pro -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
<!-- Font Awesome -->
<link rel="stylesheet" href="/static/assets/plugins/fontawesome-free/css/all.min.css">
<!-- Theme style -->
<link rel="stylesheet" href="/static/assets/css/adminlte.min.css">
{% endblock stylesheets %}

{% block content %}
<style> 
    html {
        font-family: 'Signika Negative', sans-serif;
        font-size: 1em;
    }
</style>

<!-- Content Header (Page header) -->
<section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1>{{ detalles.nombre }}</h1>
        </div>
        <div class="col-sm-6">
        </div>
      </div>
    </div><!-- /.container-fluid -->
  </section>

<h1>Carrito de compra</h1>

<table class="table table-responsive">
    <thead>
        <tr>
            
            <th scope="col">Imagen</th>
            <th scope="col">Producto</th>
            <th scope="col">Cantidad</th>
            <th scope="col">Eliminar</th>
            <th scope="col">Precio</th>
        </tr>
    </thead>
    <tbody>
        {% for item in carro %}
            {% with producto=item.producto %}
            <tr>
                <td>
                    <img class="img img-fluid" style="max-width: 200px;" src="{{producto.imagen_set.all.0.image.url}}">   
                </td>
                <td> <a href="{% url 'detalles' producto.id %}">{{ producto.nombre }}</a></td>
            <td>
                <form action="{% url 'carro_add' producto.id %}" method="post">
                    {{ item.update_cantidad_form.cantidad }}
                    {{ item.update_cantidad_form.update }}
                    <input type="submit" value="Actualiza">
                    {% csrf_token %}
                </form>
            </td>
                <td><a href="{% url 'carro_remover' producto.id %}">Eliminar</a></td>
                <td class="num">${{ item.precio_total }}</td>
            </tr>
            {% endwith %}     
            {% empty %}
                 <h5 class="px-2">No tienes articulos en el carrito</h5>

            
        {% endfor %}
        <tr class="total">
            <td>Total</td>
            <td colspan="4"></td>
            <td class="num">${{ carro.obt_precio_total }}</td>
        </tr>
    </tbody>
</table>


<div class="d-flex px-3">
    <form action="{% url 'checkout'  %}" method="post">
               
        {% csrf_token %}
    <button class="btn btn-primary" type="submit" id="checkout-button">
        Checkout
    </button>
    </form>

</div>
{% endblock content %} 

<script src="https://js.stripe.com/v3/"></script>
<script type="text/javascript">
    // Create an instance of the Stripe object with your publishable API key
    var stripe = Stripe('{{ stripe_publishable_key }}');
    var checkoutButton = document.getElementById('checkout-button');

    checkoutButton.addEventListener('click', function () {

        var email = document.getElementById('email').value;
        if (email.length == 0) {
            alert("Please enter your email address.");
            return;
        }

        // Create a new Checkout Session using the server-side endpoint you
        // created in step 3.
        fetch("{% url 'api_checkout_session' id=object.id %}", {
            method: 'POST',
            body: JSON.stringify(
                { email: email }
            )
        })
            .then(function (response) {
                return response.json();
            })
            .then(function (session) {
                return stripe.redirectToCheckout({ sessionId: session.sessionId });
            })
            .then(function (result) {
                // If `redirectToCheckout` fails due to a browser or network
                // error, you should display the localized error message to your
                // customer using `error.message`.
                if (result.error) {
                    alert(result.error.message);
                }
            })
            .catch(function (error) {
                console.error('Error:', error);
            });
    });
</script>